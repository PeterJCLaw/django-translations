name: Main

on:
  push:
    branches:
      - master
  pull_request:

jobs:
  lint:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2

    - name: Set up Python
      uses: actions/setup-python@v3
      with:
        python-version: 3.9

    - name: Install Dependencies
      run: |
        pip install flake8~=3.0

    - name: Run Flake8
      run: |
        flake8

  test:
    strategy:
      matrix:
        python-version: ["3.6", "3.7", "3.8", "3.9"]
        django-version: ["2.2", "3.0", "3.1", "3.2", "4.0"]
        exclude:
          - python-version: "3.6"
            django-version: "4.0"
          - python-version: "3.7"
            django-version: "4.0"

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v3
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install Dependencies
      run: |
        pip install django~=${{ matrix.django-version }}.0 djangorestframework~=3.0

    - name: Setup Tests
      run: |
        python create.py

    - name: Run Tests
      run: |
        python project/manage.py test -v 3

  docs-test:
    strategy:
      matrix:
        python-version: ["3.6", "3.7", "3.8", "3.9"]
        django-version: ["2.2", "3.0", "3.1", "3.2"]

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v3
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install Dependencies
      run: |
        pip install django~=${{ matrix.django-version }}.0 djangorestframework~=3.0 sphinx

    - name: Setup Tests
      run: |
        python create.py
        python config.py

    - name: Run Tests
      run: |
        make --directory docs doctest

  deploy-docs:
    if: github.event_name == 'push' && github.ref_type == 'tag'
    needs: [lint, test, docs-test]

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2

    - name: Set up Python
      uses: actions/setup-python@v3
      with:
        python-version: "3.6"

    - name: Install Dependencies
      run: |
        pip install django~=${{ matrix.django-version }}.0 djangorestframework~=3.0 sphinx

    - name: Configure
      run: |
        python config.py

    - name: Build docs
      run: |
        make --directory docs html

    - name: Deploy
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: docs/_build/html

  deploy-pypi:
    if: github.event_name == 'push' && github.ref_type == 'tag'
    needs: [lint, test, docs-test]

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2

    - name: Set up Python
      uses: actions/setup-python@v3
      with:
        python-version: "3.6"

    - name: Configure
      run: |
        python config.py

    - name: Build package
      run: |
        python setup.py sdist bdist_wheel

    - name: Publish package
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        user: __token__
        password: ${{ secrets.PYPI_API_TOKEN }}
