name: Lint & Test

on:
  push:
    branches:
      - master
  pull_request:

jobs:
  lint:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2

    - name: Set up Python
      uses: actions/setup-python@v3
      with:
        python-version: 3.9

    - name: Install Dependencies
      run: |
        pip install flake8~=3.0

    - name: Run Flake8
      run: |
        flake8

  test:
    strategy:
      matrix:
        python-version: ["3.6", "3.7", "3.8", "3.9"]
        django-version: ["2.2", "3.0", "3.1", "3.2"]

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v3
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install Dependencies
      run: |
        pip install django~=${{ matrix.django-version }}.0 djangorestframework~=3.0

    - name: Setup Tests
      run: |
        python create.py

    - name: Run Tests
      run: |
        python project/manage.py test -v 3

  docs-test:
    strategy:
      matrix:
        python-version: ["3.6", "3.7", "3.8", "3.9"]
        django-version: ["2.2", "3.0", "3.1", "3.2"]

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v3
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install Dependencies
      run: |
        pip install django~=${{ matrix.django-version }}.0 djangorestframework~=3.0 sphinx

    - name: Setup Tests
      run: |
        python create.py
        python config.py

    - name: Run Tests
      run: |
        make --directory docs doctest

  # TODO: deployment
